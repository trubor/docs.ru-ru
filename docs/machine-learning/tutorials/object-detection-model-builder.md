---
title: Руководство. Обнаружение объектов на изображениях с помощью Model Builder
description: В этом руководстве показано, как создать модель обнаружения объектов с помощью ML.NET Model Builder и Машинного обучения Azure для обнаружения знака STOP на изображениях.
author: briacht
ms.author: brachtma
ms.date: 04/13/2021
ms.topic: tutorial
ms.custom: mlnet-tooling
ms.openlocfilehash: f628be47bbef080505355fa99630c68b327f1a60
ms.sourcegitcommit: 5ddbd1f65d0369b4cc8c8ff91c72f1b524c90221
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/15/2021
ms.locfileid: "107514506"
---
# <a name="tutorial-detect-stop-signs-in-images-with-model-builder"></a>Руководство. Обнаружение знака STOP на изображениях с помощью Model Builder

Узнайте, как с помощью ML.NET Model Builder и Машинного обучения Azure создать модель обнаружения объектов для нахождения на изображениях знака STOP.

В этом руководстве вы узнаете, как:

> [!div class="checklist"]
>
> - Подготовка и анализ данных
> - выбрать сценарий;
> - выбрать среду обучения;
> - Загрузка данных
> - Обучение модели
> - Оценка модели
> - Использование модели для прогнозирования

> [!NOTE]
> Построитель моделей в настоящее время находится на этапе предварительной версии.

## <a name="prerequisites"></a>Предварительные требования

Список необходимых компонентов и инструкции по установке см. в [руководстве по установке построителя моделей](../how-to-guides/install-model-builder.md).

## <a name="model-builder-object-detection-overview"></a>Общие сведения об обнаружении объектов в Model Builder

Обнаружение объектов — это задача в области компьютерного зрения. Несмотря на связь с классификацией изображений, обнаружение объектов выполняет классификацию изображений в более детализированном масштабе. Обнаружение объектов находит _и_ категоризует сущности на изображениях. Модели обнаружения объектов обычно обучаются с использованием глубокого обучения и нейронных сетей. Дополнительные сведения: [Сравнение глубокого и машинного обучения](/azure/machine-learning/concept-deep-learning-vs-machine-learning).

Используйте обнаружение объектов, если изображения содержат несколько объектов разных типов.

![Снимки экрана с данными классификации изображений и классификации объектов.](./media/object-detection-onnx/img-classification-obj-detection.PNG)

Некоторые варианты применения обнаружения объектов:

- Автомобили с автономным управлением
- Робототехника
- Обнаружение лиц
- Техника безопасности
- Подсчет объектов
- Распознавание активности

В этом примере создается консольное приложение .NET Core на языке C#, которое определяет знак STOP на изображениях с помощью модели машинного обучения, созданной в Model Builder. Исходный код примера из этого руководства можно найти в репозитории [dotnet/machinelearning-samples](https://github.com/dotnet/machinelearning-samples/tree/main/samples/modelbuilder/ObjectDetection_StopSigns) на сайте GitHub.

## <a name="prepare-and-understand-the-data"></a>Подготовка и анализ данных

Набор данных Stop Sign содержит 50 изображений, скачанных с сайта [Unsplash](https://unsplash.com/), на каждом из которых есть хотя бы один знак STOP.

Первое, что нужно сделать, — добавить заметки к изображениям или нарисовать ограничивающие прямоугольники вокруг знаков STOP на каждом изображении. В этом руководстве показано, как добавить заметки к изображениям с помощью средства [VoTT](https://github.com/microsoft/VoTT).

> Если вы хотите пропустить шаги по маркировке данных, вы можете [скачать эту версию набора данных](https://aka.ms/mlnet-object-detection-tutorial-assets) и перейти к [созданию консольного приложения](object-detection-model-builder.md#create-a-console-application).

### <a name="create-a-new-vott-project"></a>Создание нового проекта VoTT

1. [Скачайте набор данных](https://aka.ms/mlnet-object-detection-tutorial-dataset), содержащий 50 изображений со знаком STOP, и распакуйте его.
1. [Скачайте VoTT](https://github.com/Microsoft/VoTT/releases) (средство расстановки тегов для визуальных объектов).
1. Откройте VoTT и выберите элемент **New Project** (Создать проект).

    ![Начальный экран VoTT](./media/object-detection-model-builder/vott.png)

1. В разделе **Project Settings** (Параметры проекта) укажите в поле **Display Name** (Отображаемое имя) значение StopSignObjDetection.
1. Укажите в поле **Security Token** (Маркер безопасности) значение *Generate New Security Token* (Создать новый маркер безопасности).
1. Рядом с полем **Source Connection** (Исходное подключение) щелкните элемент **Add Connection** (Добавить подключение).
1. В разделе **Connection Settings** (Параметры подключения) укажите в поле **Display Name** (Отображаемое имя) для подключения к источнику значение StopSignImages и укажите в поле **Provider** (Поставщик) значение *Local File System* (Локальная файловая система). В поле **Folder Path** (Путь к папке) укажите папку *Stop-Signs* с 50 обучающими изображениями и щелкните элемент **Save Connection** (Сохранить подключение).

    ![Диалоговое окно New Connection (Новое подключение) в VoTT](./media/object-detection-model-builder/vott-new-connection.png)

1. В разделе **Project Settings** (Параметры проекта) укажите в поле **Source Connection** (Исходное подключение) значение *StopSignImages* (только что созданное подключение).
1. В поле **Target Connection** (Целевое подключение) также укажите значение *StopSignImages*. Теперь раздел **Параметры проекта** должен выглядеть примерно так, как показано на следующем снимке экрана:

    ![Диалоговое окно Project Settings (Параметры проекта) в VoTT](./media/object-detection-model-builder/vott-new-project.png)

1. Щелкните элемент **Save Project** (Сохранить проект).

### <a name="add-tag-and-label-images"></a>Добавление тегов и меток к изображениям

Теперь вы должны увидеть окно с изображениями для предварительного просмотра всех обучающих изображений слева, выбранным изображением для предварительного просмотра в центре и столбцом **Tags** (Теги) справа. Это экран **редактора тегов**.

1. Чтобы добавить новый тег, щелкните значок плюса (первый) на панели инструментов **Tags** (Теги).

    ![Значок добавления тега в VoTT](./media/object-detection-model-builder/vott-new-tag-icon.png)

1. Назовите тег Stop-Sign и нажмите клавишу <kbd>ВВОД</kbd> на клавиатуре.

    ![Новый тег в VoTT](./media/object-detection-model-builder/vott-new-tag.png)

1. Щелкните и удерживайте левую копку мыши, чтобы нарисовать прямоугольник вокруг каждого знака STOP на изображении. Если курсор не позволяет нарисовать прямоугольник, попробуйте сделать это с помощью средства **Draw Rectangle** (Нарисовать прямоугольник) на панели инструментов вверху или используйте сочетание клавиш <kbd>R</kbd>.
1. Нарисовав прямоугольник, выберите тег **Stop-Sign**, созданный ранее, чтобы добавить его к ограничивающему прямоугольнику.
1. Щелкните в наборе данных следующее изображение для предварительного просмотра и повторите эту процедуру.
1. Продолжайте шаги 3–4 для каждого из этих изображений.

    ![Добавление заметок к изображениям в VoTT](./media/object-detection-model-builder/vott-annotating.gif)

### <a name="export-your-vott-json"></a>Экспорт JSON в VoTT

Промаркировав все обучающие изображения, можно экспортировать файл, который Model Builder будет использовать для обучения.

1. Выберите значок с диагональной стрелкой на панели инструментов слева (четвертый), чтобы перейти в раздел **Export Settings** (Параметры экспорта).
1. Оставьте в поле **Provider** (Поставщик) значение *VoTT JSON*.
1. Укажите в поле **Asset State** (Состояние ресурса) значение *Only tagged Assets* (Только ресурсы с тегами).
1. Снимите флажок **Include Images** (Включить изображения). Иначе обучающие изображения будут скопированы в создаваемую папку экспорта, что является необязательным действием.
1. Щелкните элемент **Save Export Settings** (Сохранить параметры экспорта).

    ![Параметры экспорта VoTT](./media/object-detection-model-builder/vott-export.png)

1. Вернитесь в **редактор тегов** (второй значок на панели инструментов слева в форме ленты). На верхней панели инструментов щелкните значок **Export Project** (Экспорт проекта) (последний значок в форме стрелки) или нажмите клавиши <kbd>CTRL</kbd>+<kbd>E</kbd>.

    ![Кнопка экспорта VoTT](./media/object-detection-model-builder/vott-export-button.png)

В ходе экспорта будет создана новая папка с именем *vott-json-export* в папке *Stop-Sign-Images*, которая будет содержать файл JSON с именем *StopSignObjDetection-export*. Этот файл JSON будет использоваться в следующих шагах для обучения модели обнаружения объектов в Model Builder.

## <a name="create-a-console-application"></a>Создание консольного приложение

1. В Visual Studio создайте **консольное приложение C# .NET Core** с именем *StopSignDetection*.

## <a name="choose-a-scenario"></a>Выбор сценария

1. В **Обозревателе решений** щелкните правой кнопкой мыши проект *StopSignDetection* и выберите элементы **Добавить** > **Машинное обучение**, чтобы открыть пользовательский интерфейс Model Builder.
1. В этом примере сценарий включает обнаружение объектов. На этапе **Сценарий** в Model Builder выберите сценарий **Обнаружение объектов**.

![Мастер построителя моделей в Visual Studio](./media/object-detection-model-builder/obj-det-scenario.png)

> Если вариант *Обнаружение объектов* не отображается в списке сценариев, попробуйте [обновить версию Model Builder](https://marketplace.visualstudio.com/items?itemName=MLNET.07).

## <a name="choose-the-training-environment"></a>Выбор среды обучения

Сейчас Model Builder поддерживает обучение моделей обнаружению объектов только с использованием Машинного обучения Azure, поэтому обучающая среда Azure выбрана по умолчанию.

![Выбор обучающей среды Azure](./media/object-detection-model-builder/obj-det-environment.png)

Чтобы обучить модель с помощью Машинного обучения Azure, создайте эксперимент Машинного обучения Azure в Model Builder.

**Эксперимент Машинного обучения Azure** инкапсулирует конфигурацию и результаты одного или нескольких обучающих выполнений машинного обучения.

Чтобы создать эксперимент Машинного обучения Azure, необходимо сначала настроить среду в Azure. Для выполнения эксперимента требуется следующее:

- подписка Azure;
- **рабочая область** — ресурс Машинного обучения Azure, который является централизованным расположением для всех ресурсов и артефактов Машинного обучения Azure, создаваемых в ходе обучения;
- **вычислительная среда Машинного обучения** — облачная виртуальная машина Linux, используемая для обучения; см. сведения о [вычислениях, поддерживаемых Model Builder](../resources/azure-training-concepts-model-builder.md#what-is-an-azure-machine-learning-compute).

### <a name="set-up-an-azure-ml-workspace"></a>Настройка рабочей области Машинного обучения Azure

Чтобы настроить среду:

1. Нажмите кнопку **Настроить рабочую область**.
1. В диалоговом окне **Создание нового эксперимента** выберите свою подписку Azure.
1. Создайте новую рабочую область Машинного обучения Azure или выберите существующую.

    При создании новой рабочей области подготавливаются следующие ресурсы:

    - Рабочая область службы "Машинное обучение Azure"
    - Хранилище Azure
    - Azure Application Insights
    - Реестр контейнеров Azure
    - Хранилище ключей Azure;

    В результате этот процесс может занять несколько минут.

1. Создайте новое вычисление машинного обучения Azure или выберите существующее. Это может занять несколько минут.
1. Оставьте имя эксперимента по умолчанию и щелкните элемент **Создать**.

    ![Диалоговое окно настройки рабочей области Azure](./media/object-detection-model-builder/azure-dialog.png)

Когда первый эксперимент будет создан, его имя регистрируется в рабочей области. Все последующие выполнения (при использовании одного и того же имени эксперимента) регистрируются как часть одного эксперимента. В противном случае создается новый эксперимент.

Если вас устраивает конфигурация, нажмите кнопку **Следующий шаг** в Model Builder, чтобы перейти к шагу **Данные**.

## <a name="load-the-data"></a>Загрузка данных

На шаге **Данные** в Model Builder вы выберете обучающий набор данных.

>Сейчас Model Builder принимает только файлы JSON, создаваемые в VoTT, но команда разработки планирует включить поддержку других форматов в будущем. Если есть формат набора данных для обнаружения объектов, который вы хотели бы использовать в Model Builder, оставьте свой отзыв на сайте [GitHub](https://github.com/dotnet/machinelearning-modelbuilder/issues/new?assignees=&labels=&template=data_suggestion.md&title=).

1. Нажмите кнопку рядом с текстовым полем **Выбрать папку** и воспользуйтесь проводником, чтобы найти файл `StopSignObjDetection-export.json`, который должен быть расположен в каталоге *Stop-Signs/vott-json-export*.

    ![Шаг "Данные" в Model Builder](./media/object-detection-model-builder/obj-det-data.png)

1. Если данные в разделе **Предварительная версия данных** выглядят правильно, нажмите кнопку **Следующий шаг**, чтобы перейти к шагу **Обучение**.

## <a name="train-the-model"></a>Обучение модели

Следующий шаг — обучение модели.

На экране **Обучение** в Model Builder нажмите кнопку **Начать обучение**.

На этом этапе ваши данные будут отправлены в службу хранилища Azure и в Машинном обучении Azure начнется процесс обучения.

>Точная продолжительность обучения зависит от объема данных и выбранных вычислительных ресурсов. Первое обучение модели в Azure может длиться чуть дольше, так как необходимо подготовить ресурсы. В этом примере с 50 изображениями обучение заняло около 16 минут.

Ход выполнения можно отслеживать на портале Машинного обучения Azure, щелкнув ссылку **Мониторинг текущего выполнения на портале Azure** в Visual Studio.

Когда обучение завершится, нажмите кнопку **Следующий шаг**, чтобы перейти к шагу **Оценка**.

## <a name="evaluate-the-model"></a>Оценка модели

На экране оценки вы сможете просмотреть результаты процесса обучения, а также проверить точность модели.

![Шаг "Оценка" в Model Builder](./media/object-detection-model-builder/obj-det-evaluate.png)

В этом случае точность составляет 100 %. Это означает, что модель, скорее всего, *переобучена* из-за слишком большого числа изображений в наборе данных.

Чтобы узнать, работает ли модель должным образом, можно воспользоваться возможностью **проверки модели**.

Щелкните элемент **Browse an image** (Обзор изображения) и укажите тестовое изображение — желательно такое, которое модель не использовала в процессе обучения.

![Проверка модели в Model Builder](./media/object-detection-model-builder/obj-det-try-model.png)

Оценка, отображаемая для каждого обнаруженного ограничивающего прямоугольника, указывает на **достоверность** обнаруженного объекта. Например, на снимке экрана выше оценка для ограничивающего прямоугольника вокруг знака STOP указывает на то, что модель с 99 % достоверностью распознает обнаруженный объект как знак STOP.

**Порог оценки**, который можно увеличить или уменьшить с помощью ползунка, позволяет добавлять и удалять обнаруженные объекты на основе их оценок. Например, если порог равен 0,51, модель будет показывать только те объекты, которые имеют оценку достоверности 0,51 и выше. По мере увеличения порога будет отображаться меньшее число обнаруженных объектов и наоборот.

Если вас не устраивают метрики точности, один простой способ повысить точность модели — использовать больше данных. В противном случае щелкните ссылку **Следующий шаг**, чтобы перейти к шагу **Код** в Model Builder.

## <a name="add-the-code-to-make-predictions"></a>Добавление кода для прогнозирования

В результате процесса обучения создаются два проекта.

- *StopSignDetectionML.ConsoleApp* — консольное приложение .NET Core на C# с кодом для обучения и использования модели.
- *StopSignDetectionML.Model* — библиотека классов .NET Standard с моделями данных, которые определяют схему входных и выходных данных модели, а также хранимую версию оптимальной модели во время обучения и вспомогательный класс с именем `ConsumeModel` для прогнозирования.

1. На шаге кода в Model Builder щелкните элемент **Добавить проекты**, чтобы добавить автоматически созданные проекты в решение.
1. Откройте файл *Program.cs* в проекте *StopSignDetection* и добавьте следующий оператор using в начало файла, чтобы создать ссылку на проект *StopSignDetectionML.Model*:

    [!code-csharp [ProgramUsings](~/machinelearning-samples/samples/modelbuilder/ObjectDetection_StopSigns/StopSignDetection/Program.cs#L2)]

1. Скачайте указанное ниже [тестовое изображение](~/machinelearning-samples/samples/modelbuilder/ObjectDetection_StopSigns/StopSignDetection/test-image1.jpeg).
1. Создайте новый экземпляр класса `ModelInput` со свойством `ImageSource`, для которого задан путь к файлу тестового изображения, в методе `Main` приложения. Замените Hello World следующим кодом:

    [!code-csharp [InputData](~/machinelearning-samples/samples/modelbuilder/ObjectDetection_StopSigns/StopSignDetection/Program.cs#L10-L15)]

1. Используйте метод `Predict` из класса `ConsumeModel` для загрузки обученной модели, создания [`PredictionEngine`](xref:Microsoft.ML.PredictionEngine%602) для модели и прогнозирования с использованием новых данных. Добавьте следующий код под оператором `ModelInput`:

    [!code-csharp [Prediction](~/machinelearning-samples/samples/modelbuilder/ObjectDetection_StopSigns/StopSignDetection/Program.cs#L15)]

1. Выведите выходные данные прогноза, включая метку, координаты и оценку, добавив следующий код:

    [!code-csharp [PrintResults](~/machinelearning-samples/samples/modelbuilder/ObjectDetection_StopSigns/StopSignDetection/Program.cs#L17-L18)]

1. Запустите приложение.

    Выходные данные программы должны выглядеть примерно так:

    ```bash
    Predicted Boxes:

    Top: 89.453415, Left: 481.95343, Right: 724.8073, Bottom: 388.32385, Label: Stop-Sign, Score: 0.99539465
    ```

Поздравляем! Вы успешно создали модель машинного обучения для обнаружения знака STOP в изображениях с помощью Model Builder. Исходный код примера из этого руководства можно найти в репозитории [dotnet/machinelearning-samples](https://github.com/dotnet/machinelearning-samples/tree/main/samples/modelbuilder/ObjectDetection_StopSigns) на сайте GitHub.

## <a name="additional-resources"></a>Дополнительные ресурсы

Дополнительные сведения см. в следующих статьях:

- [Сценарии для построителя моделей](../automate-training-with-model-builder.md#scenario)
- [Обнаружение объектов с помощью ONNX в ML.NET](object-detection-onnx.md)
